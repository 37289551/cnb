
name: copy

on:
  schedule:
    - cron: '30 16,18 * * *'
  workflow_dispatch:

jobs:
  copy_and_convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v3

      - name: Checkout HD repo
        uses: actions/checkout@v3
        with:
          repository: ${{ github.repository_owner }}/HD
          path: HD

      - name: Copy epg.gz file
        run: |
          mkdir -p epg
          cp HD/output/epg/epg.gz epg/

      - name: Generate hd.gz from result.m3u
        run: |
          mkdir -p channel
          gzip -c "HD/output/result.m3u" > "channel/hd.gz"

      - name: Check for changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git diff-index --quiet HEAD || git commit -m "Auto-sync files from HD repo - $(date '+%Y-%m-%d %H:%M:%S')"
          
      - name: Push changes
        run: |
          git pull --rebase origin main || true
          git push origin mai

      - name: Trigger cnbgo workflow
        run: |
          # 使用GitHub API触发cnbgo.yml工作流
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/cnbgo.yml/dispatches \
            -d '{"ref":"main"}'

