
name: copy

on:
  schedule:
    - cron: '30 16,18 * * *'
  workflow_dispatch:

jobs:
  copy_and_convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v3

      - name: Download epg.gz from GitHub
        run: |
          echo "Downloading epg.gz from GitHub..."
          mkdir -p epg
          # 删除旧文件，确保文件被正确覆盖
          rm -f epg/epg.gz || true
          # 从GitHub URL下载文件
          EPG_URL="https://github.com/37289551/SH/raw/refs/heads/main/output/epg.gz"
          echo "Downloading from: $EPG_URL"
          # 使用curl下载文件，覆盖旧文件
          curl -L -o epg/epg.gz "$EPG_URL"
          echo "Download completed. Checking result..."
          ls -la epg/
          # 验证文件是否存在且有内容
          if [ -f "epg/epg.gz" ]; then
            echo "epg/epg.gz file exists"
            file_size=$(stat -c "%s" epg/epg.gz)
            echo "File size: $file_size bytes"
            if [ $file_size -gt 0 ]; then
              echo "File has content"
            else
              echo "Warning: File is empty"
            fi
          else
            echo "Error: epg/epg.gz file does not exist after download"
          fi

      - name: Generate hd.gz from result.txt
        run: |
          mkdir -p channel
          # 检查是否已存在result.txt文件，若不存在则从GitHub下载
          if [ ! -f "result.txt" ]; then
            echo "Downloading result.txt from GitHub..."
            curl -L -o "result.m3u" "https://github.com/37289551/HD/raw/refs/heads/master/output/result.m3u"
            if [ $? -eq 0 ]; then
              echo "Download completed."
            else
              echo "Error: Failed to download result.txt"
              exit 1
            fi
          fi

          # 检查result.txt文件是否存在
          if [ -f "result.txt" ]; then
            echo "Generating hd.gz from result.txt"
            # 删除旧文件
            rm -f channel/hd.gz || true
            # 生成新文件
            gzip -c "result.txt" > "channel/hd.gz"
            echo "Generation completed. Checking result..."
            ls -la channel/
            # 验证文件是否存在且有内容
          if [ -f "channel/hd.gz" ]; then
              echo "channel/hd.gz file exists"
              file_size=$(stat -c "%s" channel/hd.gz)
              echo "File size: $file_size bytes"
              if [ $file_size -gt 0 ]; then
                  echo "File has content"
              else
                echo "Warning: File is empty"
              fi
          else
            echo "Error: channel/hd.gz file does not exist after generation"
          fi
          fi


      - name: Check for changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git diff-index --quiet HEAD || git commit -m "Auto-sync files from HD repo - $(date '+%Y-%m-%d %H:%M:%S')"
          
      - name: Push changes
        run: |
          # 先拉取远程更改，解决冲突
          git pull --rebase origin main || true
          # 推送更改
          git push origin main

      - name: Trigger cnbgo workflow
        run: |
          # 使用GitHub API触发cnbgo.yml工作流
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/fepg.yml/dispatches \
            -d '{"ref":"main"}'


