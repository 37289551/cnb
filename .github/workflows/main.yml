
name: copy

on:
  schedule:
    - cron: '30 16,18 * * *'
  workflow_dispatch:

jobs:
  copy_and_convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v3

      - name: Checkout HD repo
        uses: actions/checkout@v3
        with:
          repository: ${{ github.repository_owner }}/HD
          path: HD
          ref: main  # 确保使用main分支的最新代码

      - name: Check HD repository structure
        run: |
          echo "Checking HD repository structure..."
          ls -la HD/
          ls -la HD/output/ || echo "HD/output/ directory does not exist"
          ls -la HD/output/epg/ || echo "HD/output/epg/ directory does not exist"
          ls -la HD/output/epg/epg.gz || echo "HD/output/epg/epg.gz file does not exist"

      - name: Copy epg.gz file
        run: |
          echo "Copying epg.gz file..."
          mkdir -p epg
          # 删除旧文件，确保文件被正确刷新
          rm -f epg/epg.gz || true
          # 复制新文件
          cp HD/output/epg/epg.gz epg/
          echo "Copy completed. Checking result..."
          ls -la epg/
          # 验证文件是否存在且有内容
          if [ -f "epg/epg.gz" ]; then
            echo "epg/epg.gz file exists"
            file_size=$(stat -c "%s" epg/epg.gz)
            echo "File size: $file_size bytes"
            if [ $file_size -gt 0 ]; then
              echo "File has content"
            else
              echo "Warning: File is empty"
            fi
          else
            echo "Error: epg/epg.gz file does not exist after copy"
          fi

      - name: Generate hd.gz from result.m3u
        run: |
          mkdir -p channel
          gzip -c "HD/output/result.m3u" > "channel/hd.gz"

      - name: Check for changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git diff-index --quiet HEAD || git commit -m "Auto-sync files from HD repo - $(date '+%Y-%m-%d %H:%M:%S')"
          
      - name: Push changes
        run: |
          # 先拉取远程更改，解决冲突
          git pull --rebase origin main || true
          # 推送更改
          git push origin main

      - name: Trigger cnbgo workflow
        run: |
          # 使用GitHub API触发cnbgo.yml工作流
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/cnbgo.yml/dispatches \
            -d '{"ref":"main"}'

